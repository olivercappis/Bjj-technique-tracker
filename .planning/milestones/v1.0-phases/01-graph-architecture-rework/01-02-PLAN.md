---
phase: 01-graph-architecture-rework
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/components/game-plan/flowchart-view.tsx
  - src/components/game-plan/color-legend.tsx
  - src/components/game-plan/list-view.tsx
  - src/stores/game-plan-store.ts
  - src/pages/game-plan.tsx
  - src/components/game-plan/technique-edge.tsx
autonomous: false

must_haves:
  truths:
    - "User sees positions and techniques as separate, visually distinct nodes in the flowchart"
    - "User sees sweeps and transitions creating arrows to resulting position nodes"
    - "User sees all positions with techniques as entry points (multiple roots)"
    - "User can drag nodes and positions persist across page refresh"
    - "User can pan and zoom the flowchart canvas"
    - "User can toggle a color legend showing technique type colors"
    - "Dagre auto-layout produces clean top-to-bottom arrangement on initial render"
    - "List view continues to work correctly, displaying positions with their techniques grouped by type"
  artifacts:
    - path: "src/components/game-plan/flowchart-view.tsx"
      provides: "Updated FlowchartView wiring both node types, Dagre with dual dimensions, position persistence"
      exports: ["FlowchartView"]
    - path: "src/components/game-plan/color-legend.tsx"
      provides: "Toggleable color legend panel using React Flow Panel"
      exports: ["ColorLegend"]
    - path: "src/components/game-plan/list-view.tsx"
      provides: "Updated ListView working with techniqueIds prop, resolving data independently"
      exports: ["ListView"]
    - path: "src/stores/game-plan-store.ts"
      provides: "Zustand store with version 2 (clears stale nodePositions from old ID scheme)"
    - path: "src/pages/game-plan.tsx"
      provides: "Game plan page wired to new graph builder return type, passing correct props to both views"
      exports: ["GamePlanPage"]
  key_links:
    - from: "src/components/game-plan/flowchart-view.tsx"
      to: "src/components/game-plan/position-node.tsx"
      via: "nodeTypes registration"
      pattern: "nodeTypes.*position.*PositionNode"
    - from: "src/components/game-plan/flowchart-view.tsx"
      to: "src/components/game-plan/technique-node.tsx"
      via: "nodeTypes registration"
      pattern: "nodeTypes.*technique.*TechniqueNode"
    - from: "src/components/game-plan/flowchart-view.tsx"
      to: "src/lib/game-plan-graph.ts"
      via: "receives nodes/edges from page"
      pattern: "PositionFlowNode|TechniqueFlowNode"
    - from: "src/pages/game-plan.tsx"
      to: "src/lib/game-plan-graph.ts"
      via: "calls buildGamePlanGraph and passes result to FlowchartView"
      pattern: "buildGamePlanGraph"
    - from: "src/pages/game-plan.tsx"
      to: "src/components/game-plan/list-view.tsx"
      via: "passes techniqueIds to ListView for independent data resolution"
      pattern: "ListView.*techniqueIds"
    - from: "src/stores/game-plan-store.ts"
      to: "src/components/game-plan/flowchart-view.tsx"
      via: "provides nodePositions and updateNodePositions"
      pattern: "updateNodePositions|nodePositions"
---

<objective>
Wire the new bipartite graph into the FlowchartView, update ListView for the new data shape, add a toggleable color legend, bump the store version, and update the game plan page to pass correct props to both views.

Purpose: This plan connects all the pieces from Plan 01 into a working, interactive flowchart and ensures the list view tab continues to function. Without this wiring, the new node components and graph builder have no visual output, and the list view would be broken by the deleted types.

Output: Fully functional flowchart with position and technique nodes rendered, color legend toggle, Dagre auto-layout, drag persistence, pan/zoom, and a working list view. The user can see their complete game plan as an interactive bipartite graph or as a structured list.
</objective>

<execution_context>
@C:/Users/cappi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cappi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-graph-architecture-rework/01-RESEARCH.md
@.planning/phases/01-graph-architecture-rework/01-01-SUMMARY.md

@src/components/game-plan/flowchart-view.tsx
@src/components/game-plan/technique-edge.tsx
@src/components/game-plan/list-view.tsx
@src/stores/game-plan-store.ts
@src/pages/game-plan.tsx
@src/lib/game-plan-graph.ts
@src/components/game-plan/position-node.tsx
@src/components/game-plan/technique-node.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update FlowchartView, ListView, game plan page, store version, and add color legend</name>
  <files>src/components/game-plan/flowchart-view.tsx, src/components/game-plan/color-legend.tsx, src/components/game-plan/list-view.tsx, src/stores/game-plan-store.ts, src/pages/game-plan.tsx, src/components/game-plan/technique-edge.tsx</files>
  <action>
**1. Update `src/stores/game-plan-store.ts`:**
- Change `version: 1` to `version: 2` in the persist config. This clears stale `nodePositions` keyed by old unprefixed IDs. No migration function needed — Zustand will reset the store to defaults on version mismatch.
- No other changes to the store.

**2. Create `src/components/game-plan/color-legend.tsx` (new file):**
- Import `Panel` from `@xyflow/react`
- Import `TechniqueType` from `@/types`
- Define `legendItems: Record<TechniqueType, { label: string; color: string }>`:
  - submission: { label: "Submission", color: "#ef4444" }
  - sweep: { label: "Sweep", color: "#3b82f6" }
  - escape: { label: "Escape", color: "#10b981" }
  - transition: { label: "Transition", color: "#f59e0b" }
  - pass: { label: "Pass", color: "#8b5cf6" }
  - takedown: { label: "Takedown", color: "#f97316" }
- Component takes `{ visible: boolean }` prop. If `!visible`, return `null`.
- Render using `<Panel position="top-right">` with a card-styled container: `className="bg-card/95 backdrop-blur-sm border border-border rounded-xl p-3 shadow-lg"`
- Header text: "Technique Types" — `className="text-[10px] text-muted-foreground font-semibold uppercase tracking-wider mb-2"`
- Map over legendItems to render each as a row: colored circle `<span className="w-3 h-3 rounded-full inline-block" style={{ backgroundColor: color }} />` + label text `<span className="text-xs text-foreground">{label}</span>`
- Export as named export `ColorLegend`

**3. Delete `src/components/game-plan/technique-edge.tsx`:**
Delete the file entirely. The old `TechniqueEdge` component rendered technique names as edge labels — in the new architecture, technique names live in `TechniqueNode` components, so edges are simple styled arrows. Default React Flow edges with inline `style` and `markerEnd` props set on each edge object will replace it. Remove the `edgeTypes` registration from FlowchartView as well (see step 4).

**4. Rewrite `src/components/game-plan/flowchart-view.tsx`:**

Update the component to wire the new bipartite graph data:

- **Imports:** Replace `GamePlanNode`, `GamePlanEdge` imports with `PositionFlowNode`, `TechniqueFlowNode` from `@/lib/game-plan-graph`. Import `TechniqueNode` from `./technique-node`. Keep `PositionNode` import. Import `ColorLegend` from `./color-legend`. Import `useState` from React. Remove `TechniqueEdge` import.
- **nodeTypes:** Update to `{ position: PositionNode, technique: TechniqueNode }` — defined OUTSIDE the component (keep existing pattern). Remove `edgeTypes` entirely — use default edges.
- **Dual node dimensions:**
  ```
  const POSITION_NODE_WIDTH = 180;
  const POSITION_NODE_HEIGHT = 60;
  const TECHNIQUE_NODE_WIDTH = 160;
  const TECHNIQUE_NODE_HEIGHT = 36;
  ```
- **applyDagreLayout update:** When calling `g.setNode`, check `node.type`: if `"position"`, use position dimensions; if `"technique"`, use technique dimensions. Keep `rankdir: "TB"`. Adjust `nodesep: 60` and `ranksep: 80` for a tighter graph (more nodes now). Keep the savedPositions override logic unchanged. When computing position offsets after dagre.layout, use the correct width/height for each node type (not a single NODE_WIDTH/HEIGHT).
- **Props:** Change props to accept `nodes: (PositionFlowNode | TechniqueFlowNode)[]` and `edges: Array<{ id: string; source: string; target: string }>` (matching the new `buildGamePlanGraph` return type). Update the interface name to match.
- **Node mapping:** Nodes from the new builder already have `id`, `type`, `position`, and `data` fields — they ARE React Flow nodes. Pass them directly to `applyDagreLayout` without remapping. Then pass to `useNodesState`.
- **Edge mapping:** Map edges to add `markerEnd: { type: MarkerType.ArrowClosed, width: 14, height: 14 }` and `style: { stroke: "oklch(0.55 0.02 260 / 0.5)", strokeWidth: 1.5 }`. Use default edge type (no custom `type` field).
- **Legend toggle:** Add `const [legendVisible, setLegendVisible] = useState(false)` state. Inside `<ReactFlow>`, add a `<Panel position="top-left">` with a toggle button: `<button onClick={() => setLegendVisible(v => !v)} className="bg-card/90 backdrop-blur-sm border border-border rounded-lg px-3 py-1.5 text-xs font-medium text-muted-foreground hover:text-foreground transition-colors shadow-sm">Legend</button>`. Add `<ColorLegend visible={legendVisible} />` inside the ReactFlow component.
- **Position persistence:** Keep the existing `onNodeDragStop` callback that saves all node positions to the store. The new prefixed IDs (`pos-*`, `tech-*`) will be saved as keys — this works correctly with the existing `Record<string, {x,y}>` type.
- **Zustand selector:** Instead of `getActiveGamePlan()` called in render, use a selector for the specific fields needed: `const activePlan = useGamePlanStore(s => s.gamePlans.find(p => p.id === s.activeGamePlanId))` and `const updateNodePositions = useGamePlanStore(s => s.updateNodePositions)`. This avoids re-render storms from `getActiveGamePlan` creating new object references (per research pitfall #6).

**5. Rewrite `src/components/game-plan/list-view.tsx`:**

The ListView currently imports `GamePlanNode` and `GamePlanEdge` from `@/lib/game-plan-graph` and deeply accesses their old shape (`node.position.name`, `node.category.perspective`, `node.submissions`, `edge.technique.name`, `edge.technique.type`). These types are deleted in Plan 01. Rewrite ListView to work independently from the store's `techniqueIds` rather than consuming the new bipartite graph data (which is optimized for React Flow, not list rendering).

New approach:
- **Props:** Change `ListViewProps` to accept `techniqueIds: string[]` instead of `graphNodes`/`graphEdges`.
- **Imports:** Remove `GamePlanNode`, `GamePlanEdge` imports from `@/lib/game-plan-graph`. Import `techniques, positions, categories` from `@/data`. Keep existing imports for `Link`, `ArrowRight`, `cn`, `TypeBadge`.
- **Data resolution:** Inside the component, resolve `techniqueIds` to full technique objects using the `techniques` data array. Group techniques by `positionId`. For each position group:
  - Look up the `Position` and `PositionCategory` from the data arrays
  - Split techniques into `submissions` (type === "submission") and `transitions` (those with `resultingPositionId` and not submissions)
  - Render the same card layout as before: position name as header, perspective-based left border color, submissions section, transitions section with type badge + arrow + target position name
- **Keep the existing visual design** — the card layout with perspective borders, submission badges, and transition rows with TypeBadge and arrow icons. Only the data source changes (from pre-built graph nodes to direct data resolution).
- **Position path helper:** Keep `getPositionPath` and `getTargetPositionName` functions unchanged.

**6. Update `src/pages/game-plan.tsx`:**
- The page currently passes `graphNodes={nodes} graphEdges={edges}` to both `FlowchartView` and `ListView`. Update these:
  - `FlowchartView`: Change props to `nodes={nodes} edges={edges}` to match the new FlowchartView prop interface.
  - `ListView`: Change props to `techniqueIds={techniqueIds}` since ListView now resolves its own data from the store's technique IDs.
- Remove the import of `GamePlanNode`/`GamePlanEdge` types if present (they no longer exist).
- Update the header position count: the old `nodes.length` counted only position nodes. The new `nodes` array includes both position and technique nodes. Use `nodes.filter(n => n.type === "position").length` for the position count display.
  </action>
  <verify>
1. Run `npx tsc --noEmit` — must pass with zero errors across all modified files
2. Run `npm run build` (or `npx vite build`) — must produce a successful build with no errors
3. Run `npm run dev` and visually verify (checkpoint below)
  </verify>
  <done>
All files compile. The build succeeds. FlowchartView renders both position and technique node types using the new graph builder output. ListView renders correctly from techniqueIds with the same visual design as before. Edges connect correctly. Legend toggle works. Store version bumped to 2. technique-edge.tsx is deleted.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete flowchart and list view rendering</name>
  <files>None — verification only</files>
  <action>
Human verifies the complete Phase 1 Graph Architecture Rework visually and interactively. All automation is complete in Task 1. This checkpoint confirms the visual output and interactive behavior match requirements.

What was built:
- Positions render as rounded rectangles with technique count badges
- Techniques render as colored pill/capsule nodes connected to their source positions
- Submissions glow red with no outgoing arrows (terminal endpoints)
- Sweeps and transitions have arrows pointing to resulting positions
- All positions with techniques appear as entry points (multiple roots)
- Color legend toggles via button in top-left corner
- Drag to rearrange persists across page refresh
- Pan and zoom work on the canvas
- List view tab continues to display position cards with grouped techniques

How to verify:
1. Run `npm run dev` and navigate to the Game Plan page
2. If no techniques are in the plan, add several:
   - At least 2 submissions from different positions (e.g., Triangle Choke from Closed Guard, Armbar from Mount)
   - At least 1 sweep with a resulting position (to verify sweep chaining)
   - At least 1 escape or transition (to verify color differentiation)
3. Return to the Game Plan page, select the Flowchart tab
4. Verify:
   a. Position nodes are rounded rectangles with the position name and a count badge in the corner
   b. Technique nodes are pill-shaped with distinct colors per type
   c. Submission nodes have a red glow effect and NO outgoing arrows
   d. Sweep/transition nodes have arrows pointing to their resulting position
   e. Multiple positions appear as independent roots (not forced into a single tree)
   f. Click the "Legend" button in the top-left — a color legend panel appears showing all 6 types
   g. Click "Legend" again — the panel disappears
   h. Drag a node to a new position, refresh the page — the node stays where you put it
   i. Zoom in/out with scroll wheel and pan by dragging the canvas background
5. Switch to the List View tab
6. Verify:
   j. Each position appears as a card with the position name
   k. Submissions are shown as red badges within their position card
   l. Transitions/sweeps show the technique name, type badge, and an arrow to the target position
   m. Clicking a position name or target position name navigates to the correct page
  </action>
  <verify>Human confirms all 13 verification items (a through m) pass visual inspection.</verify>
  <done>User types "approved" confirming the flowchart and list view render correctly with all visual and interactive requirements met, or describes issues for correction.</done>
</task>

</tasks>

<verification>
Full phase verification — all 11 requirements plus list view:
- GRAPH-01: Position nodes render as standalone nodes (not containers)
- GRAPH-02: Technique nodes render as separate connected nodes
- GRAPH-03: Technique nodes color-coded by type (6 colors)
- GRAPH-04: Submissions styled as terminal endpoints with glow, no outgoing edges
- GRAPH-05: Techniques with resultingPositionId have edges to resulting positions
- GRAPH-06: Chained positions display their techniques (resulting positions with selected techniques show their technique nodes too)
- GRAPH-07: All positions with user-selected techniques appear as roots (multiple entry points)
- GRAPH-08: Dagre auto-layout on initial render, preserved user-dragged positions
- GRAPH-09: Technique count badges on position nodes
- INTX-04: Drag nodes to rearrange with persistence
- INTX-05: Pan and zoom the canvas
- LIST: List view continues to function with same visual design
</verification>

<success_criteria>
1. Application builds and runs without errors (`npm run build` succeeds)
2. FlowchartView renders both position (rounded rect) and technique (pill) node types
3. Edges connect position -> technique and technique -> resulting position correctly
4. Submission nodes have glow effect and no outgoing edges
5. Color legend toggles visibility from a canvas button
6. Node drag positions persist across page refresh via Zustand
7. Pan and zoom work on the canvas
8. List view tab renders position cards with grouped techniques correctly
9. Human verification passes on visual correctness for both views
</success_criteria>

<output>
After completion, create `.planning/phases/01-graph-architecture-rework/01-02-SUMMARY.md`
</output>
