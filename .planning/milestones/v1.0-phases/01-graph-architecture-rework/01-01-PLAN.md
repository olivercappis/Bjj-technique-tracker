---
phase: 01-graph-architecture-rework
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/game-plan-graph.ts
  - src/types/game-plan.ts
  - src/components/game-plan/position-node.tsx
  - src/components/game-plan/technique-node.tsx
autonomous: true

must_haves:
  truths:
    - "Foundation: Positions render as standalone nodes separate from techniques (verified structurally via type-check and export verification; visual verification in 01-02)"
    - "Foundation: Techniques render as their own nodes connected to source positions via edges (verified structurally; visual verification in 01-02)"
    - "Foundation: Technique nodes are color-coded by type (submission, sweep, escape, transition, pass, takedown) (verified structurally; visual verification in 01-02)"
    - "Foundation: Submission nodes have extra visual emphasis (glow + thick border) and no outgoing edges (verified structurally; visual verification in 01-02)"
    - "Foundation: Sweeps/transitions with resultingPositionId produce an edge to the resulting position (verified structurally; visual verification in 01-02)"
    - "Foundation: Technique count badges appear on position nodes showing plan-specific counts (verified structurally; visual verification in 01-02)"
  artifacts:
    - path: "src/lib/game-plan-graph.ts"
      provides: "Bipartite graph builder with separate position and technique nodes"
      exports: ["buildGamePlanGraph", "PositionFlowNode", "TechniqueFlowNode"]
      contains: "pos-"
    - path: "src/types/game-plan.ts"
      provides: "GamePlan type (unchanged or minor extension)"
    - path: "src/components/game-plan/position-node.tsx"
      provides: "Rounded rectangle position node with technique count badge"
      exports: ["PositionNode"]
    - path: "src/components/game-plan/technique-node.tsx"
      provides: "Pill-shaped technique node with type-based color and submission glow"
      exports: ["TechniqueNode"]
  key_links:
    - from: "src/lib/game-plan-graph.ts"
      to: "src/types/index.ts"
      via: "imports Technique, Position, TechniqueType types"
      pattern: "import.*from.*@/types"
    - from: "src/components/game-plan/technique-node.tsx"
      to: "src/lib/game-plan-graph.ts"
      via: "consumes TechniqueFlowNode data shape"
      pattern: "techniqueType|isSubmission"
    - from: "src/components/game-plan/position-node.tsx"
      to: "src/lib/game-plan-graph.ts"
      via: "consumes PositionFlowNode data shape"
      pattern: "techniqueCount"
---

<objective>
Rework the graph builder to produce separate position and technique nodes, and create the visual node components for both types.

Purpose: This is the core architectural change — transforming the graph from "positions containing technique lists" into a bipartite graph where techniques are first-class nodes with their own shape, color, and connection behavior. Without this, sweep chaining and type-based styling are impossible.

Output: Updated `game-plan-graph.ts` producing bipartite node/edge data, reworked `PositionNode` component, new `TechniqueNode` component with color-coded pill styling.
</objective>

<execution_context>
@C:/Users/cappi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cappi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-graph-architecture-rework/01-RESEARCH.md

@src/lib/game-plan-graph.ts
@src/types/game-plan.ts
@src/types/index.ts
@src/data/techniques.ts
@src/components/game-plan/position-node.tsx
@src/components/game-plan/technique-edge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rework graph builder to produce bipartite position + technique nodes</name>
  <files>src/lib/game-plan-graph.ts, src/types/game-plan.ts</files>
  <action>
Rewrite `buildGamePlanGraph` in `src/lib/game-plan-graph.ts` to produce separate position and technique nodes instead of embedding techniques inside position nodes.

**New types to export from game-plan-graph.ts:**

```typescript
export interface PositionFlowNode {
  id: string;            // "pos-{positionId}"
  type: "position";
  position: { x: number; y: number };
  data: {
    positionId: string;
    name: string;
    categoryName: string;
    perspective: string;  // "top" | "bottom" | "both"
    techniqueCount: number;  // count of selected techniques from this position
  };
}

export interface TechniqueFlowNode {
  id: string;            // "tech-{techniqueId}"
  type: "technique";
  position: { x: number; y: number };
  data: {
    techniqueId: string;
    name: string;
    techniqueType: TechniqueType;
    isSubmission: boolean;
  };
}
```

**New return type:**
```typescript
export function buildGamePlanGraph(techniqueIds: string[]): {
  nodes: (PositionFlowNode | TechniqueFlowNode)[];
  edges: Array<{ id: string; source: string; target: string }>;
}
```

**Edge generation rules:**
1. For every selected technique: create edge `{ id: "e-pos-tech-{techniqueId}", source: "pos-{positionId}", target: "tech-{techniqueId}" }` — position to technique
2. For techniques with `resultingPositionId` that are NOT submissions: create edge `{ id: "e-tech-pos-{techniqueId}", source: "tech-{techniqueId}", target: "pos-{resultingPositionId}" }` — technique to resulting position
3. Submissions NEVER get an outgoing edge (even if they somehow have a resultingPositionId)

**Position collection:** Gather all positions referenced by selectedTechniques via `positionId` AND `resultingPositionId`. For each unique position, create a PositionFlowNode. The `techniqueCount` on each position node should count only techniques in the user's plan that originate from that position (not all techniques in the data).

**Node ID scheme:** Use `pos-{positionId}` for position nodes and `tech-{techniqueId}` for technique nodes. This prevents ID collisions between the two types.

**All nodes start with `position: { x: 0, y: 0 }`** — Dagre layout is applied later in FlowchartView (Plan 02).

Remove the old `GamePlanNode` and `GamePlanEdge` interfaces. They are replaced by the new types above.

Keep the `src/types/game-plan.ts` GamePlan interface unchanged — it already has `nodePositions?: Record<string, { x: number; y: number }>` which will work with the new prefixed IDs after the store version bump in Plan 02.
  </action>
  <verify>
Run `npx tsc --noEmit` — should pass with no errors in game-plan-graph.ts. Files that import old `GamePlanNode`/`GamePlanEdge` types (flowchart-view.tsx, position-node.tsx, list-view.tsx, game-plan.tsx page) will have type errors — that is expected and will be fixed in Plan 02. Verify the new file exports `buildGamePlanGraph`, `PositionFlowNode`, and `TechniqueFlowNode`.
  </verify>
  <done>
`buildGamePlanGraph` returns a flat array of PositionFlowNode and TechniqueFlowNode items with prefixed IDs, plus an edges array with position-to-technique and technique-to-position connections. Submissions have no outgoing edges. Position nodes include correct techniqueCount from plan-selected techniques only.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create technique node component and rework position node component</name>
  <files>src/components/game-plan/technique-node.tsx, src/components/game-plan/position-node.tsx</files>
  <action>
**Create `src/components/game-plan/technique-node.tsx` (new file):**

A memoized React component rendering technique nodes as pill/capsule shapes with type-based coloring.

Structure:
- Import `memo` from React, `Handle` and `Position` from `@xyflow/react`
- Import `TechniqueType` from `@/types`
- Define `TechniqueNodeData` interface matching the `data` field of `TechniqueFlowNode` from game-plan-graph.ts: `{ techniqueId: string; name: string; techniqueType: TechniqueType; isSubmission: boolean }`
- Define `techniqueColors` as a `Record<TechniqueType, React.CSSProperties>` using the color palette from the existing `technique-edge.tsx` for consistency:
  - **submission**: red-500 (#ef4444) — translucent background `rgba(239, 68, 68, 0.12)`, border `#ef4444`, text `#fca5a5`, borderWidth `2px`, PLUS `boxShadow: "0 0 10px 2px rgba(239, 68, 68, 0.35), 0 0 20px 4px rgba(239, 68, 68, 0.15)"` for glow emphasis per user decision
  - **sweep**: blue-500 (#3b82f6) — translucent bg `rgba(59, 130, 246, 0.12)`, border `#3b82f6`, text `#93c5fd`, borderWidth `2px`
  - **escape**: emerald-500 (#10b981) — translucent bg `rgba(16, 185, 129, 0.12)`, border `#10b981`, text `#6ee7b7`, borderWidth `2px`
  - **transition**: amber-500 (#f59e0b) — translucent bg `rgba(245, 158, 11, 0.12)`, border `#f59e0b`, text `#fcd34d`, borderWidth `2px`
  - **pass**: violet-500 (#8b5cf6) — translucent bg `rgba(139, 92, 246, 0.12)`, border `#8b5cf6`, text `#c4b5fd`, borderWidth `2px`
  - **takedown**: orange-500 (#f97316) — translucent bg `rgba(249, 115, 22, 0.12)`, border `#f97316`, text `#fdba74`, borderWidth `2px`

- Component renders a `<div>` with `className="rounded-full px-3 py-1.5 text-xs font-medium whitespace-nowrap min-w-24 max-w-48 text-center truncate"` and `style={techniqueColors[data.techniqueType]}`
- Always render `<Handle type="target" position={Position.Top} />` (incoming from position)
- Conditionally render `<Handle type="source" position={Position.Bottom} />` ONLY when `!data.isSubmission` — submissions are terminal, no outgoing connections per user decision
- Handle styling: `className="!w-2 !h-2 !bg-current !border-0"` (small, uses the node's text color)
- Export as `const TechniqueNode = memo(TechniqueNodeComponent)`

**Rework `src/components/game-plan/position-node.tsx`:**

Simplify from the current version that embeds technique lists to a clean rounded rectangle with a count badge.

- Remove all imports/references to `GamePlanNode`, `Technique`, `cn`, and the perspectiveColors/perspectiveBadgeColors maps
- Import `memo` from React, `Handle` and `Position` from `@xyflow/react`
- Define `PositionNodeData` interface matching the `data` field of `PositionFlowNode`: `{ positionId: string; name: string; categoryName: string; perspective: string; techniqueCount: number }`
- Component renders a `<div>` with `className="rounded-xl border-2 border-border bg-card px-4 py-3 min-w-[160px] shadow-md relative"` — rounded rectangle shape per user decision
- Content: position name centered via `<p className="text-sm font-bold text-foreground text-center">{data.name}</p>`
- Count badge: `<span className="absolute -top-2 -right-2 flex h-5 w-5 items-center justify-center rounded-full bg-primary text-[10px] font-bold text-primary-foreground shadow-sm">{data.techniqueCount}</span>` — positioned in top-right corner per user decision
- Handles: target on Top, source on Bottom. Styling: `className="!bg-primary !w-3 !h-3 !border-2 !border-card"`
- Export as `const PositionNode = memo(PositionNodeComponent)`
- Do NOT include category badge, submissions list, or technique text — keep the node minimal and clean per user decision ("position name + small count badge")
  </action>
  <verify>
Run `npx tsc --noEmit` on the two component files in isolation. Both should have no internal type errors. The `TechniqueNode` file should export `TechniqueNode`. The `PositionNode` file should export `PositionNode`. Visual verification will happen after Plan 02 wires these into FlowchartView.
  </verify>
  <done>
`TechniqueNode` renders as a pill/capsule with type-based color (6 distinct colors matching existing edge colors), submission glow via box-shadow, and conditional source handle (absent for submissions). `PositionNode` renders as a clean rounded rectangle with name and technique count badge in top-right corner. Both are memoized and exported.
  </done>
</task>

</tasks>

<verification>
After both tasks:
- `src/lib/game-plan-graph.ts` exports `buildGamePlanGraph`, `PositionFlowNode`, `TechniqueFlowNode`
- `src/components/game-plan/technique-node.tsx` exports `TechniqueNode` (memoized)
- `src/components/game-plan/position-node.tsx` exports `PositionNode` (memoized, reworked)
- Type-check the three new/modified files: `npx tsc --noEmit` (expect errors only in downstream consumers like flowchart-view.tsx, list-view.tsx, and game-plan.tsx page which still reference old types — those are fixed in Plan 02)
</verification>

<success_criteria>
1. Graph builder produces separate position nodes (prefixed `pos-`) and technique nodes (prefixed `tech-`) from a list of technique IDs
2. Edges correctly connect position -> technique for all techniques, and technique -> resulting-position for sweeps/transitions (not submissions)
3. Submission technique nodes have `isSubmission: true` and generate no outgoing edges
4. Position nodes include `techniqueCount` reflecting only plan-selected techniques
5. TechniqueNode component applies 6 distinct colors with submission glow
6. PositionNode component shows name + count badge with no embedded technique lists
</success_criteria>

<output>
After completion, create `.planning/phases/01-graph-architecture-rework/01-01-SUMMARY.md`
</output>
