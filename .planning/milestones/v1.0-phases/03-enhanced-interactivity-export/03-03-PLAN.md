---
phase: 03-enhanced-interactivity-export
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/components/game-plan/export-button.tsx
  - src/components/game-plan/flowchart-view.tsx
  - package.json
autonomous: false

must_haves:
  truths:
    - "User can click an Export PNG button on the flowchart and a PNG file downloads"
    - "The exported PNG contains all visible nodes and edges with correct styling"
    - "The Export button is inside the flowchart viewport as a Panel (consistent with Legend button)"
    - "All Phase 3 features work together: hover highlighting, edge tooltips, click-to-detail sheets, PNG export"
  artifacts:
    - path: "src/components/game-plan/export-button.tsx"
      provides: "Export button using html-to-image toPng with React Flow viewport utilities"
    - path: "package.json"
      provides: "html-to-image@1.11.11 pinned as exact dependency"
  key_links:
    - from: "src/components/game-plan/export-button.tsx"
      to: "@xyflow/react"
      via: "useReactFlow().getNodes() for bounds calculation"
      pattern: "useReactFlow|getNodesBounds|getViewportForBounds"
    - from: "src/components/game-plan/flowchart-view.tsx"
      to: "src/components/game-plan/export-button.tsx"
      via: "ExportButton rendered as Panel child inside ReactFlow"
      pattern: "ExportButton"
---

<objective>
Add PNG export functionality and verify all Phase 3 features visually.

Purpose: Users can export their game plan flowchart as a PNG image to save or share with training partners — completing the Phase 3 feature set.

Output: ExportButton component, html-to-image dependency, full Phase 3 human verification.
</objective>

<execution_context>
@C:/Users/cappi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/cappi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-enhanced-interactivity-export/03-RESEARCH.md
@.planning/phases/03-enhanced-interactivity-export/03-02-SUMMARY.md

@src/components/game-plan/flowchart-view.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install html-to-image and create ExportButton component</name>
  <files>package.json, src/components/game-plan/export-button.tsx, src/components/game-plan/flowchart-view.tsx</files>
  <action>
**Install dependency:**
```bash
npm install html-to-image@1.11.11
```
CRITICAL: Must be exactly version 1.11.11. Newer versions have CSS regression and browser freeze bugs. Verify with `npm ls html-to-image` that installed version is 1.11.11.

**export-button.tsx (new file):**
1. Import `useReactFlow`, `getNodesBounds`, `getViewportForBounds` from `@xyflow/react`.
2. Import `toPng` from `html-to-image`.
3. Import `useCallback` from React.
4. Import `Download` icon from `lucide-react` for the button icon.
5. Define constants: `IMAGE_WIDTH = 1920`, `IMAGE_HEIGHT = 1080`.
6. Create `downloadImage(dataUrl: string)` helper: creates an anchor element, sets `download` to `"game-plan.png"`, sets `href` to dataUrl, calls `click()`.
7. Export `ExportButton` component:
   - Get `{ getNodes }` from `useReactFlow()`.
   - `handleExport` callback (wrapped in `useCallback`):
     a. `const nodesBounds = getNodesBounds(getNodes())`.
     b. `const viewport = getViewportForBounds(nodesBounds, IMAGE_WIDTH, IMAGE_HEIGHT, 0.5, 2, 0.1)`.
     c. Get viewport element: `document.querySelector<HTMLElement>(".react-flow__viewport")`.
     d. If no viewport element, return early.
     e. Call `toPng(viewportEl, { backgroundColor: "#0f1117", width: IMAGE_WIDTH, height: IMAGE_HEIGHT, style: { width: String(IMAGE_WIDTH), height: String(IMAGE_HEIGHT), transform: \`translate(${viewport.x}px, ${viewport.y}px) scale(${viewport.zoom})\` }, filter: (node) => { if (node instanceof Element) { return !node.classList.contains("react-flow__minimap") && !node.classList.contains("react-flow__controls") && !node.classList.contains("react-flow__panel"); } return true; } }).then(downloadImage)`.
   - Render: button with Download icon and "Export PNG" text.
   - Button styling: match the Legend button pattern: `bg-card/90 backdrop-blur-sm border border-border rounded-lg px-3 py-1.5 text-xs font-medium text-muted-foreground hover:text-foreground transition-colors shadow-sm flex items-center gap-1.5`.

**FlowchartView changes:**
1. Import `ExportButton` from `./export-button`.
2. Add a `<Panel position="top-right">` containing `<ExportButton />` inside the `<ReactFlow>` component, alongside the existing `<Panel position="top-left">` for Legend.
  </action>
  <verify>Run `npm ls html-to-image` — version is exactly 1.11.11. Run `npx tsc --noEmit` — no type errors. Run `npm run dev`, open game plan flowchart with techniques, click Export PNG — a `game-plan.png` file downloads. Open the PNG — it shows all nodes and edges with correct colors and layout, no minimap/controls/panel UI.</verify>
  <done>Export button visible in flowchart top-right. Clicking it downloads a 1920x1080 PNG of the game plan with all nodes, edges, and styling intact. Minimap, controls, and panels are excluded from the export.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of all Phase 3 features</name>
  <files>N/A — verification only</files>
  <action>
Human verifies all Phase 3 features: hover highlighting (INTX-06), edge tooltips (INTX-07), technique detail sheet (INTX-01), position browser sheet (INTX-02), PNG export (EXPRT-01).

Steps to verify:
1. Open http://localhost:5173/game-plan with a plan containing at least 3-4 techniques across 2+ positions
2. **Hover highlighting (INTX-06):**
   - Hover over a technique node — connected position nodes and edges stay bright, everything else dims
   - Hover over a position node — connected technique nodes and edges stay bright, everything else dims
   - Hover over an edge — the edge and its two endpoint nodes stay bright, everything else dims
   - Move mouse away — all nodes and edges return to full opacity
3. **Edge tooltip (INTX-07):**
   - Hover over a technique->position edge (an edge going FROM a technique TO a position) — tooltip appears showing technique name and type
   - Hover over a position->technique edge — NO tooltip appears (correct, no redundant info)
4. **Technique detail (INTX-01):**
   - Click a technique node — right-side Sheet opens showing: technique name, type badge, difficulty indicator, description, steps, tips
   - Sheet scrolls if content is long
   - Click X or outside to close
5. **Position browser (INTX-02):**
   - Click a position node — right-side Sheet opens showing: position name, all techniques from that position with Add to Plan buttons
   - Click "Add to Plan" on a technique not yet in the plan — it gets added
   - Close the Sheet — new technique appears in the flowchart
6. **Remove button (regression check):**
   - Hover a technique node — remove "x" button appears
   - Click the remove button — technique is removed, Sheet does NOT open
7. **PNG export (EXPRT-01):**
   - Click "Export PNG" button in top-right of flowchart
   - A `game-plan.png` file downloads
   - Open the PNG — it shows the full flowchart with correct node colors and edge arrows, no minimap/controls/buttons visible
8. **No performance issues:** No lag during hover, no stuck highlight states, no render loops

Resume signal: Type "approved" or describe issues found.
  </action>
  <verify>Human confirms all 8 verification steps pass.</verify>
  <done>All Phase 3 requirements (INTX-01, INTX-02, INTX-06, INTX-07, EXPRT-01) verified by human.</done>
</task>

</tasks>

<verification>
All 5 Phase 3 requirements verified:
- INTX-01: Technique node click opens detail Sheet
- INTX-02: Position node click opens browser Sheet with Add to Plan
- INTX-06: Hover highlighting dims unconnected paths
- INTX-07: Edge tooltip shows technique name and type
- EXPRT-01: Export PNG downloads full flowchart image
</verification>

<success_criteria>
- html-to-image pinned at exactly 1.11.11
- ExportButton renders inside ReactFlow as Panel (has useReactFlow() context)
- PNG export includes all nodes/edges, excludes UI controls
- Human verification confirms all 5 Phase 3 requirements work correctly
- No regressions in Phase 1 (graph architecture) or Phase 2 (plan management) features
</success_criteria>

<output>
After completion, create `.planning/phases/03-enhanced-interactivity-export/03-03-SUMMARY.md`
</output>
